"""
HTML Structure:

The complete question package for each question is wrapped up in following html example:

    <div class="result-pane--question-result-pane-wrapper--2bGiz" bis_skin_checked="1">
        <div class="result-pane--question-result-pane--sIcOh result-pane--accordion-panel--TEJg7"
            bis_skin_checked="1">
            <div class="result-pane--question-header-wrapper--3DCpC" bis_skin_checked="1">
                INCLUDES HTML THAT HOLDS THE QUESTION
            </div>
            <div class="result-pane--question-result-pane-expanded-content--Og5Vc" bis_skin_checked="1">
                <div class="result-pane--answer-result-pane--Niazi" bis_skin_checked="1">
                    <div class="answer-result-pane--answer-skipped--1NDPn" data-purpose="answer"
                        bis_skin_checked="1">
                        <div class="answer-result-pane--answer-body--cDGY6" data-purpose="answer-body"
                            bis_skin_checked="1"><span data-purpose="answer-result-body-selection-icon"
                                class="answer-result-pane--answer-selection-icon--O6Xkn"><svg aria-hidden="true"
                                    focusable="false" class="ud-icon ud-icon-small"
                                    style="color: rgb(145, 148, 172);">
                                    <use xlink:href="#icon-radio-empty"></use>
                                </svg></span>
                            <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
                                class="ud-heading-md rt-scaffolding" id="answer-text" bis_skin_checked="1">
                                <p><code>SHOW @stage_name;</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-pane--answer-result-pane--Niazi" bis_skin_checked="1">
                    <div class="answer-result-pane--answer-skipped--1NDPn" data-purpose="answer"
                        bis_skin_checked="1">
                        <div class="answer-result-pane--answer-body--cDGY6" data-purpose="answer-body"
                            bis_skin_checked="1"><span data-purpose="answer-result-body-selection-icon"
                                class="answer-result-pane--answer-selection-icon--O6Xkn"><svg aria-hidden="true"
                                    focusable="false" class="ud-icon ud-icon-small"
                                    style="color: rgb(145, 148, 172);">
                                    <use xlink:href="#icon-radio-empty"></use>
                                </svg></span>
                            <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
                                class="ud-heading-md rt-scaffolding" id="answer-text" bis_skin_checked="1">
                                <p><code>SHOW @%stage_name;</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-pane--answer-result-pane--Niazi" bis_skin_checked="1">
                    <div class="answer-result-pane--answer-skipped--1NDPn" data-purpose="answer"
                        bis_skin_checked="1">
                        <div class="answer-result-pane--answer-body--cDGY6" data-purpose="answer-body"
                            bis_skin_checked="1"><span data-purpose="answer-result-body-selection-icon"
                                class="answer-result-pane--answer-selection-icon--O6Xkn"><svg aria-hidden="true"
                                    focusable="false" class="ud-icon ud-icon-small"
                                    style="color: rgb(145, 148, 172);">
                                    <use xlink:href="#icon-radio-empty"></use>
                                </svg></span>
                            <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
                                class="ud-heading-md rt-scaffolding" id="answer-text" bis_skin_checked="1">
                                <p><code>DESC @stage_name;</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-pane--answer-result-pane--Niazi" bis_skin_checked="1">
                    <div class="answer-result-pane--answer-skipped--1NDPn" data-purpose="answer"
                        bis_skin_checked="1">
                        <div class="answer-result-pane--answer-body--cDGY6" data-purpose="answer-body"
                            bis_skin_checked="1"><span data-purpose="answer-result-body-selection-icon"
                                class="answer-result-pane--answer-selection-icon--O6Xkn"><svg aria-hidden="true"
                                    focusable="false" class="ud-icon ud-icon-small"
                                    style="color: rgb(145, 148, 172);">
                                    <use xlink:href="#icon-radio-empty"></use>
                                </svg></span>
                            <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
                                class="ud-heading-md rt-scaffolding" id="answer-text" bis_skin_checked="1">
                                <p><code>DESC @%stage_name;</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-pane--answer-result-pane--Niazi" bis_skin_checked="1">
                    <div class="answer-result-pane--answer-correct--PLOEU" data-purpose="answer"
                        bis_skin_checked="1">
                        <div bis_skin_checked="1"><span data-purpose="answer-result-header-user-label"
                                class="result-pane--answer-by-user-label--PSH86 ud-heading-xs"
                                style="background: rgb(140, 211, 176); color: rgb(18, 56, 37);">Your answer is
                                correct</span></div>
                        <div class="answer-result-pane--answer-body--cDGY6" data-purpose="answer-body"
                            bis_skin_checked="1"><span data-purpose="answer-result-body-selection-icon"
                                class="answer-result-pane--answer-selection-icon--O6Xkn"><svg aria-hidden="true"
                                    focusable="false" class="ud-icon ud-icon-small"
                                    style="color: rgb(32, 34, 48);">
                                    <use xlink:href="#icon-success"></use>
                                </svg></span>
                            <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
                                class="ud-heading-md rt-scaffolding" id="answer-text" bis_skin_checked="1">
                                <p><code>LIST @stage_name;</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-pane--answer-result-pane--Niazi" bis_skin_checked="1">
                    <div class="answer-result-pane--answer-skipped--1NDPn" data-purpose="answer"
                        bis_skin_checked="1">
                        <div class="answer-result-pane--answer-body--cDGY6" data-purpose="answer-body"
                            bis_skin_checked="1"><span data-purpose="answer-result-body-selection-icon"
                                class="answer-result-pane--answer-selection-icon--O6Xkn"><svg aria-hidden="true"
                                    focusable="false" class="ud-icon ud-icon-small"
                                    style="color: rgb(145, 148, 172);">
                                    <use xlink:href="#icon-radio-empty"></use>
                                </svg></span>
                            <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
                                class="ud-heading-md rt-scaffolding" id="answer-text" bis_skin_checked="1">
                                <p><code>LIST @%stage_name;</code> </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-pane--question-related-fields--c3m--" bis_skin_checked="1">
                    <div class="overall-explanation-pane--overall-explanation--G-hLQ ud-form-group"
                        bis_skin_checked="1"><label class="ud-heading-md ud-form-label ud-heading-sm"
                            for="form-group--4797">Overall explanation</label>
                        <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
                            class="ud-text-md rt-scaffolding" id="overall-explanation" bis_skin_checked="1">
                            <p>LIST&nbsp;is used to list all files.</p>
                            <p>A named stage is referred to by using <code>@stage_name;</code>.</p>
                            <p>A table stage is referred to by using <code>@%stage_name;</code>.</p>
                            <p>A user stage is referred to by using <code>@~;</code>.</p>
                        </div>
                    </div>
                    <div data-purpose="resource-pane" class="resource-pane--resource-pane--si5L5"
                        bis_skin_checked="1">
                        <div class="resource-pane--resource-pane-header--VbZ7-" bis_skin_checked="1">
                            <strong>Resources</strong></div>
                        <div class="resource-pane--resource-pane-element--rfEVA" bis_skin_checked="1"><svg
                                aria-hidden="true" focusable="false"
                                class="ud-icon ud-icon-small ud-icon-color-info">
                                <use xlink:href="#icon-video"></use>
                            </svg>
                            <div tabindex="0"
                                class="item-link item-link--common--j8WLy item-link--default-theme--hHAh2"
                                role="link" bis_skin_checked="1"><button type="button"
                                    class="ud-btn ud-btn-medium ud-btn-ghost ud-heading-sm ud-link-underline ud-text-md"><span
                                        class="ud-btn-label">External Stages</span></button></div>
                        </div>
                    </div>
                    <div data-purpose="domain-pane" class="domain-pane--domain-pane--Pw9dK"
                        bis_skin_checked="1">
                        <div class="domain-pane--domain-pane-header--2263m ud-heading-md" bis_skin_checked="1">
                            Domain</div>
                        <div class="ud-text-md" bis_skin_checked="1">Data Loading and Unloading</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

# the question is inside a div with id 'question-prompt'.
Example:
    <div data-purpose="safely-set-inner-html:rich-text-viewer:html"
        class="result-pane--question-format--PBvdY ud-text-md rt-scaffolding"
        id="question-prompt" bis_skin_checked="1">
        <p>Which command is sued to show all files in a named internal stage?</p>
    </div>

# The answer section is wrapped in div with class "result-pane--question-result-pane-expanded-content--<variable alphanumeric string>".
Example:
    <div class="result-pane--question-result-pane-expanded-content--Og5Vc" bis_skin_checked="1">
        WHOLE LOT ANSWER AND EXPLAINATION RELATED CONTENT.
    </div>

# Explaination section is also in the above answer wrapper itself but a different div with the class "result-pane--question-related-fields--c3m--"

"""

from bs4 import BeautifulSoup
import os, csv, aws_integration
from datetime import datetime

class Scrapper():
    
    data_dir = ''
    file_name = ''
    full_path = ''
    html_content = ''
    data_list = []

    def __init__(self):
        self.data_dir = self.get_fmt_path()
        self.file_name = input('Enter the html file name (default: snowflake-quiz.html): ').strip() or "snowflake-quiz.html"
        self.full_path = self.data_dir + "/" + self.file_name
        print("Locating file at: ", self.full_path)
        try:
            self.load_html()
        except Exception as e:
            print(f"An error occurred: {e}")

    def get_fmt_path(self):
        # Get the directory of the current script
        script_dir = os.path.dirname(os.path.abspath(__file__))

        # Define the path for the new directory
        return os.path.join(script_dir, 'data')

    def load_html(self):
        try:

            with open( self.full_path, 'r', encoding='utf-8') as file:
                self.html_content = file.read()

            soup = BeautifulSoup(self.html_content, 'html.parser')
            # Find all question sections
            # The question section is wrapped in a div with class 'result-pane--question-result-pane-wrapper--2bGiz'
            # and the question text is inside a div with id 'question-prompt'.
            # The answer section is inside a div with class 'result-pane--question-result-pane-expanded-content--<variable alphanumeric string>'
            # look for span inside the answer section with any of the following text
            #     - Your answer is correct.
            #     - Your selection is correct.
            #     - Correct selection
            #     - Correct answer
            # The correct answer text is inside the div with class 'ud-heading-md rt-scaffolding' 
            # which resides in the sibling div of the parent of the span that includes the text from above list.
            # and the explanation section is inside a div with class 'result-pane--question-related-fields--c3m--'.
            questions = soup.find_all('div', class_='result-pane--question-result-pane-wrapper--2bGiz')
            
            for question in questions:
                data_row = {}
                # Extract the question text
                question_text = question.find('div', id='question-prompt')
                if question_text:
                    question_text = question_text.get_text(strip=True)
                    data_row['question'] = ' '.join(question_text.split()).strip()
                else:
                    question_text = "No question text found."
                # Extract the answer section
                answer_section = question.find('div', class_='result-pane--question-result-pane-expanded-content--Og5Vc')
                if answer_section:
                    answers = answer_section.find_all('div', class_='answer-result-pane--answer-correct--PLOEU')
                    correct_answers = []
                    for answer in answers:
                        correct_answer = answer.find('div', class_='ud-heading-md rt-scaffolding')
                        if correct_answer:
                            correct_answers.append(' '.join(correct_answer.get_text().split()).strip())
                    data_row['correct_answers'] = correct_answers
                    # Extract the explanation section
                    explanation_section = answer_section.find('div', class_='overall-explanation-pane--overall-explanation--G-hLQ')
                    explanation_text = explanation_section.get_text(strip=True) if explanation_section else "No explanation found."
                    data_row['explanation'] = explanation_text.lstrip('Overall explanation').strip()
                    data_row['explanation'] = ' '.join(data_row['explanation'].split())
                    domain = answer_section.find('div', class_='domain-pane--domain-pane--Pw9dK')
                    if domain:
                        domain_text = domain.get_text(strip=True)
                        data_row['domain'] = ' '.join(domain_text[6:].split())
                    self.data_list.append(data_row)
                    print(f"Data Compiled and stored in the class variable data_list.")
                else:
                    print(f"No answer section found for question: {question_text}")
            
            # print( self.data_list)
            if self.data_list:
                csv_file = self.store_data_to_csv()
                if csv_file:
                    uploaded = aws_integration.upload_to_s3(csv_file, 'mshakalya-aws-bucket', '/snowflake-quiz-data/' + os.path.basename(csv_file))
                    if uploaded:
                        print(f"Data successfully uploaded to S3 bucket.")
                    else:
                        print("Failed to upload data to S3 bucket.")
                else:
                    print("Failed to store data in CSV.")

            else:
                print("No data found to store in CSV.")
        except FileNotFoundError:
            print(f"The file {self.file_name} does not exist at the location \"{self.data_dir}\".")
        except Exception as e:
            print(f"An error occurred while reading the file: {e}")
            
    def store_data_to_csv(self):
        timestamp = datetime.now().strftime("%Y-%m-%d::%H:%M:%S")
        csv_file = f"{self.data_dir}/csv/snowflake_quiz_data_{timestamp}.csv"
        try:
            with open(csv_file, 'w+', newline='', encoding='utf-8') as file:
                writer = csv.writer(file)
                # Write the header
                writer.writerow(['ID', 'Question', 'Correct Answers', 'Explanation', 'Tech Domain'])
                # Write the data rows
                row_id = 1
                for row in self.data_list:
                    writer.writerow([row_id, row['question'], '\\n'.join(row['correct_answers']), row['explanation'].strip(), row['domain'].strip()])
                    row_id += 1
            print(f"Data successfully stored in {csv_file}")
            return csv_file
        except Exception as e:
            print(f"An error occurred while writing to the CSV file: {e}")

        return None

scrap = Scrapper()
